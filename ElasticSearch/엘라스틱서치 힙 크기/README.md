# 엘라스틱서치 힙 크기

 엘라스틱서치는 Java 언어로 개발되어 JVM 위에서 동작합니다. JVM 기반의 애플리케이션은 개발자가 직접 메모리 관리를 하지 않아도 된다는 큰 장점이 있습니다. 메모리 관리의 책임은 전적으로 JVM이 맡고, GC(Garbage Collection)라는 메커니즘을 이용하여 일정 주기로 사용하지 않는 메모리를 자동으로 회수합니다.

 엘라스틱서치 상에서는 JVM 옵션을 수정할 수 있도록 config 디렉토리에 **jvm.option** 파일이 존재합니다. jvm.option 파일에는 기본으로 제공하는 JVM 힙 크기가 1GB로 설정되어 있습니다. 이는 엘라스틱서치를 실행할 수 있는 최소한의 힙 크기가 1GB이기 때문입니다. 이 기본 설정은 테스트 용도이며, 실제 운영환경에서의 힙 크기는 1GB보다 반드시 커야합니다.

## 힙 크기를 32GB 이하로 유지해야 하는 이유

 엘라스틱서치는 메모리를 많이 사용하는 애플리케이션입니다. 우리는 시스템에서 제공되는 물리 메모리를 JVM 힙에 할당해서 엘라스틱서치가 사용하도록 설정할 수 있습니다. 일반적으로 힙 메모리가 많을수록 그에 비례에서 성능도 올라갑니다.

 자바 애플리케이션에서 너무 작은 힙 크기는 OOM 오류(Out-Of-Memory Exception)를 발생시킬 수 있으며, 반대로 너무 큰 힙 크기는 FullGC가 발생할 때 시스템 전체가 마비되는 STW(Stop The World)를 발생시킬 수 있습니다.

 일반적인 상황에서는 엘라스틱서치에 설정된 힙의 크기가 클수록 좋습니다. 하지만 그렇다고해서 무작정 큰 메모리를 할당하는 것은 성능에 심각한 문제를 야기시킬 수 있습니다. **엘라스틱서치에서는 할당할 힙 크기의 최대값으로 32GB 이하를 설정하도록 권장합니다.**

#### 운영체제에 50%의 메모리 공간을 보장하여 루씬에게 메모리를 제공하자

 엘라스틱서치 샤드는 내부에 루씬을 가지고 있으며 루씬은 세그먼트 생성 및 관리를 위해 커널 시스템 캐시를 최대한 활용합니다. **시스템 캐시는 운영체제가 가지고 있는 메모리 공간으로 커널 내부에 존재합니다.** 그러므로 물리적은 메모리 공간의 50% 정도는 운영체제가 자유롭게 사용하도록 할당하고 나머지 50% 정도를 엘라스틱서치 힙으로 할당하는 것이 좋습니다.

#### 자바 8 기반에서는 힙 크기를 32GB 이상 사용하지 말자

 엘라스틱서치는 힙 크기를 가급적이면 크게 설정하되 최대 32GB 이상을 사용하지 말 것을 권장합니다. 그렇다고해서 32GB 이상의 힙 크기를 설정하는 것이 불가능한 것은 아닙니다.

 엘라스틱서치에서 이러한 제한을 두는 이유는 핫스폿(Hot-Spot) JVM의 Object Pointer 정책 때문입니다. 엘라스틱서치 뿐만 아니라 모든 자바 애플리케이션에서도 Object Pointer 정책이 모두 동일하게 적용되기 때문에 최대 힙 크기를 32GB로 제한하는 것은 모든 자바 애플리케이션에도 동일하게 해당하는 내용입니다.

#### Object Point?

 Object Point는 객체의 메모리 번지를 표현하는 주소값입니다. 힙에 생성된 모든 객체는 이러한 주소값을 이용하여 접근하게 됩니다. JVM은 32비트 JVM과 64비트 JVM이 별도로 제공됩니다.  하지만 32비트 JVM과 64비트 JVM 모두 기본적으로 32비트 주소값을 가지고 동작합니다. 그 이유는 모든 JVM이 기본적으로 32비트 Object Pointer를 사용하고 있기 때문입니다.

---

## 참고자료

[엘라스틱서치 실무 가이드](http://www.kyobobook.co.kr/product/detailViewKor.laf?ejkGb=KOR&mallGb=KOR&barcode=9791158391485&orderClick=LAG&Kc=)<<권택환, 김동우, 김흥래, 박진현, 최용호, 황희정 지음>>

[https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html](https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html)